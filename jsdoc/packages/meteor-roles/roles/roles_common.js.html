<!DOCTYPE html>
<html>
<head>
  <title>roles_common.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../doc-style.css" />
  <script src="../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../";
    var thisFile = "packages\\meteor-roles\\roles\\roles_common.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>roles_common.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">;
(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<div class="dox">
<div class="summary">
<p>Provides functions related to user authorization. Compatible with built-in Meteor accounts packages.</p>
</div>
<div class="body">
</div>
<div class="details">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<div class="dox">
<div class="summary">
<p>Roles collection documents consist only of an id and a role name.
ex: { _id:<uuid>, name: &quot;admin&quot; }</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (!Meteor.roles) {
        Meteor.roles = <span class="hljs-keyword">new</span> Meteor.Collection(<span class="hljs-string">"roles"</span>)
    }
    <span class="hljs-keyword">if</span>(!Subroles){
        Subroles = <span class="hljs-keyword">new</span> Meteor.Collection(<span class="hljs-string">"subroles"</span>)
    }


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<div class="dox">
<div class="summary">
<p>Authorization package compatible with built-in Meteor accounts system.</p>
<p>Stores user's current roles in a 'roles' field on the user object.</p>
</div>
<div class="body">
</div>
<div class="details">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (<span class="hljs-string">'undefined'</span> === <span class="hljs-keyword">typeof</span> Roles) {
        Roles = {}
    }<span class="hljs-meta">

    "use strict"</span>;

    <span class="hljs-keyword">var</span> mixingGroupAndNonGroupErrorMsg = <span class="hljs-string">"Roles error: Can't mix grouped and non-grouped roles for same user"</span>;

    _.extend(Roles, {

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<div class="dox">
<div class="summary">
<p>Constant used to reference the special 'global' group that
can be used to apply blanket permissions across all groups.</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Type</div>
<div class="dox_tag_detail">
<span class="dox_type">trin</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">        GLOBAL_GROUP: <span class="hljs-string">'__global_roles__'</span>,


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<div class="dox">
<div class="summary">
<p>Create a new role. Whitespace will be trimmed.</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">role</span>
<span class="dox_type">String</span>
<span>Name of role
</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span class="dox_type">String</span>
<span>id of new role
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">        createRole: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">role</span>) </span>{
            <span class="hljs-keyword">var</span> id,
                match

            <span class="hljs-keyword">if</span> (!role
                || <span class="hljs-string">'string'</span> !== <span class="hljs-keyword">typeof</span> role
                || role.trim().length === <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">return</span>
            }

            <span class="hljs-keyword">try</span> {
                id = Meteor.roles.insert({<span class="hljs-string">'name'</span>: role.trim()})
                <span class="hljs-keyword">return</span> id
            } <span class="hljs-keyword">catch</span> (e) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>(from Meteor accounts-base package, insertUserDoc func)
XXX string parsing sucks, maybe
https://jira.mongodb.org/browse/SERVER-3069 will get fixed one day</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                <span class="hljs-keyword">if</span> (e.name !== <span class="hljs-string">'MongoError'</span>) <span class="hljs-keyword">throw</span> e
                match = e.err.match(<span class="hljs-regexp">/^E11000 duplicate key error index: ([^ ]+)/</span>)
                <span class="hljs-keyword">if</span> (!match) <span class="hljs-keyword">throw</span> e
                <span class="hljs-keyword">if</span> (match[<span class="hljs-number">1</span>].indexOf(<span class="hljs-string">'$name'</span>) !== <span class="hljs-number">-1</span>)
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Meteor.Error(<span class="hljs-number">403</span>, <span class="hljs-string">"Role already exists."</span>)
                <span class="hljs-keyword">throw</span> e
            }
        },

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<div class="dox">
<div class="summary">
<p>Delete an existing role.  Will throw &quot;Role in use&quot; error if any users
are currently assigned to the target role.</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">role</span>
<span class="dox_type">String</span>
<span>Name of role
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">        deleteRole: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">role</span>) </span>{
            <span class="hljs-keyword">if</span> (!role) <span class="hljs-keyword">return</span>

            <span class="hljs-keyword">var</span> foundExistingUser = Meteor.users.findOne(
                {<span class="hljs-attr">roles</span>: {<span class="hljs-attr">$in</span>: [role]}},
                {<span class="hljs-attr">fields</span>: {<span class="hljs-attr">_id</span>: <span class="hljs-number">1</span>}})

            <span class="hljs-keyword">if</span> (foundExistingUser) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Meteor.Error(<span class="hljs-number">403</span>, <span class="hljs-string">'Role in use'</span>)
            }

            <span class="hljs-keyword">var</span> thisRole = Meteor.roles.findOne({<span class="hljs-attr">name</span>: role})
            <span class="hljs-keyword">if</span> (thisRole) {
                Meteor.roles.remove({<span class="hljs-attr">_id</span>: thisRole._id})
            }
        },

        <span class="hljs-attr">deleteSubRole</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">subRole</span>) </span>{
            <span class="hljs-keyword">if</span> (!subRole) <span class="hljs-keyword">return</span>

            Meteor.roles.update({}, {<span class="hljs-attr">$pull</span>: {<span class="hljs-string">"subRoles"</span>: {<span class="hljs-attr">$in</span>: [subRole]}}}, {<span class="hljs-attr">multi</span>: <span class="hljs-literal">true</span>})
        },

        <span class="hljs-attr">deleteSubRoleFormRole</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">role, subRole</span>) </span>{
            <span class="hljs-keyword">if</span> (!role || !subRole) <span class="hljs-keyword">return</span>

            Meteor.roles.update({<span class="hljs-attr">name</span>: role}, {<span class="hljs-attr">$pull</span>: {<span class="hljs-string">"subRoles"</span>: {<span class="hljs-attr">$in</span>: [subRole]}}})
        },

        <span class="hljs-attr">addSubRoleToRole</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">role, subRole</span>) </span>{
            Meteor.roles.update({<span class="hljs-attr">name</span>: role}, {<span class="hljs-attr">$push</span>: {<span class="hljs-string">"subRoles"</span>: subRole}})
        },

        <span class="hljs-attr">addRolesToUsers</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">user, roles</span>) </span>{
            Meteor.users.update({<span class="hljs-attr">name</span>: user}, {<span class="hljs-attr">$push</span>: {<span class="hljs-string">"roles"</span>: roles}});
        },
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<div class="dox">
<div class="summary">
<p>Add users to roles. Will create roles as needed.</p>
<p>NOTE: Mixing grouped and non-grouped roles for the same user
is not supported and will throw an error.</p>
<p>Makes 2 calls to database:</p>
<ol>
<li>retrieve list of all existing roles</li>
<li>update users' roles</li>
</ol>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">users</span>
<span class="dox_type">Array</span>
<span class="dox_type">String</span>
<span>User id(s) or object(s) with an _id field
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">roles</span>
<span class="dox_type">Array</span>
<span class="dox_type">String</span>
<span>Name(s) of roles/permissions to add users to
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">[group]</span>
<span class="dox_type">String</span>
<span>Optional group name. If supplied, roles will be                         specific to that group.
Group names can not start with '$' or numbers.
Periods in names '.' are automatically converted
to underscores.
The special group Roles.GLOBAL_GROUP provides
a convenient way to assign blanket roles/permissions
across all groups.  The roles/permissions in the
Roles.GLOBAL_GROUP group will be automatically
included in checks for any group.
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">        addUsersToRoles: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">users, roles, group</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>use Template pattern to update user roles</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            Roles._updateUserRoles(users, roles, group, Roles._update_$addToSet_fn)
        },

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<div class="dox">
<div class="summary">
<p>Set a users roles/permissions.</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">users</span>
<span class="dox_type">Array</span>
<span class="dox_type">String</span>
<span>User id(s) or object(s) with an _id field
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">roles</span>
<span class="dox_type">Array</span>
<span class="dox_type">String</span>
<span>Name(s) of roles/permissions to add users to
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">[group]</span>
<span class="dox_type">String</span>
<span>Optional group name. If supplied, roles will be                         specific to that group.
Group names can not start with '$'.
Periods in names '.' are automatically converted
to underscores.
The special group Roles.GLOBAL_GROUP provides
a convenient way to assign blanket roles/permissions
across all groups.  The roles/permissions in the
Roles.GLOBAL_GROUP group will be automatically
included in checks for any group.
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">        setUserRoles: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">users, roles, group</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>use Template pattern to update user roles</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            Roles._updateUserRoles(users, roles, group, Roles._update_$set_fn)
        },

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<div class="dox">
<div class="summary">
<p>Remove users from roles</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">users</span>
<span class="dox_type">Array</span>
<span class="dox_type">String</span>
<span>User id(s) or object(s) with an _id field
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">roles</span>
<span class="dox_type">Array</span>
<span class="dox_type">String</span>
<span>Name(s) of roles to add users to
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">[group]</span>
<span class="dox_type">String</span>
<span>Optional. Group name. If supplied, only that                         group will have roles removed.
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">        removeUsersFromRoles: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">users, roles, group</span>) </span>{
            <span class="hljs-keyword">var</span> update

            <span class="hljs-keyword">if</span> (!users) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Missing 'users' param"</span>)
            <span class="hljs-keyword">if</span> (!roles) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Missing 'roles' param"</span>)
            <span class="hljs-keyword">if</span> (group) {
                <span class="hljs-keyword">if</span> (<span class="hljs-string">'string'</span> !== <span class="hljs-keyword">typeof</span> group)
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Roles error: Invalid parameter 'group'. Expected 'string' type"</span>)
                <span class="hljs-keyword">if</span> (<span class="hljs-string">'$'</span> === group[<span class="hljs-number">0</span>])
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Roles error: groups can not start with '$'"</span>)

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>convert any periods to underscores</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                group = group.replace(<span class="hljs-regexp">/\./g</span>, <span class="hljs-string">'_'</span>)
            }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<p>ensure arrays</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            <span class="hljs-keyword">if</span> (!_.isArray(users)) users = [users]
            <span class="hljs-keyword">if</span> (!_.isArray(roles)) roles = [roles]

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<p>ensure users is an array of user ids</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            users = _.reduce(users, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">memo, user</span>) </span>{
                <span class="hljs-keyword">var</span> _id
                <span class="hljs-keyword">if</span> (<span class="hljs-string">'string'</span> === <span class="hljs-keyword">typeof</span> user) {
                    memo.push(user)
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">'object'</span> === <span class="hljs-keyword">typeof</span> user) {
                    _id = user._id
                    <span class="hljs-keyword">if</span> (<span class="hljs-string">'string'</span> === <span class="hljs-keyword">typeof</span> _id) {
                        memo.push(_id)
                    }
                }
                <span class="hljs-keyword">return</span> memo
            }, [])

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<p>update all users, remove from roles set</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
            <span class="hljs-keyword">if</span> (group) {
                update = {<span class="hljs-attr">$pullAll</span>: {}}
                update.$pullAll[<span class="hljs-string">'roles.'</span> + group] = roles
            } <span class="hljs-keyword">else</span> {
                update = {<span class="hljs-attr">$pullAll</span>: {<span class="hljs-attr">roles</span>: roles}}
            }

            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">if</span> (Meteor.isClient) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<p>Iterate over each user to fulfill Meteor's 'one update per ID' policy</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                    _.each(users, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">user</span>) </span>{
                        Meteor.users.update({<span class="hljs-attr">_id</span>: user}, update)
                    })
                } <span class="hljs-keyword">else</span> {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<p>On the server we can leverage MongoDB's $in operator for performance</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                    Meteor.users.update({<span class="hljs-attr">_id</span>: {<span class="hljs-attr">$in</span>: users}}, update, {<span class="hljs-attr">multi</span>: <span class="hljs-literal">true</span>})
                }
            }
            <span class="hljs-keyword">catch</span> (ex) {
                <span class="hljs-keyword">var</span> removeNonGroupedRoleFromGroupMsg = <span class="hljs-string">'Cannot apply $pull/$pullAll modifier to non-array'</span>

                <span class="hljs-keyword">if</span> (ex.name === <span class="hljs-string">'MongoError'</span> &amp;&amp;
                    ex.err === removeNonGroupedRoleFromGroupMsg) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(mixingGroupAndNonGroupErrorMsg)
                }

                <span class="hljs-keyword">throw</span> ex
            }
        },

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<div class="dox">
<div class="summary">
<p>Check if user has specified permissions/roles</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">user</span>
<span class="dox_type">String</span>
<span class="dox_type">Object</span>
<span>User Id or actual user object
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">roles</span>
<span class="dox_type">String</span>
<span class="dox_type">Array</span>
<span>Name of role/permission or Array of                            roles/permissions to check against.  If array,
will return true if user is in <em>any</em> role.
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">[group]</span>
<span class="dox_type">String</span>
<span>Optional. Name of group. If supplied, limits check                         to just that group.
The user's Roles.GLOBAL_GROUP will always be checked
whether group is specified or not.
</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span class="dox_type">Boolean</span>
<span>true if user is in <em>any</em> of the target roles
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">        userIsInRole: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">user, roles, group</span>) </span>{
            <span class="hljs-keyword">var</span> id,
                userRoles,
                query,
                groupQuery,
                found = <span class="hljs-literal">false</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21"></a>
</div>
<p>ensure array to simplify code</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            <span class="hljs-keyword">if</span> (!_.isArray(roles)) {
                roles = [roles]
            }

            <span class="hljs-keyword">if</span> (!user) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
            <span class="hljs-keyword">if</span> (group) {
                <span class="hljs-keyword">if</span> (<span class="hljs-string">'string'</span> !== <span class="hljs-keyword">typeof</span> group) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
                <span class="hljs-keyword">if</span> (<span class="hljs-string">'$'</span> === group[<span class="hljs-number">0</span>]) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22"></a>
</div>
<p>convert any periods to underscores</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                group = group.replace(<span class="hljs-regexp">/\./g</span>, <span class="hljs-string">'_'</span>)
            }

            <span class="hljs-keyword">if</span> (<span class="hljs-string">'object'</span> === <span class="hljs-keyword">typeof</span> user) {
                userRoles = user.roles
                <span class="hljs-keyword">if</span> (_.isArray(userRoles)) {
                    <span class="hljs-keyword">return</span> _.some(roles, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">role</span>) </span>{
                        <span class="hljs-keyword">return</span> _.contains(userRoles, role)
                    })
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">'object'</span> === <span class="hljs-keyword">typeof</span> userRoles) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23"></a>
</div>
<p>roles field is dictionary of groups</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                    found = _.isArray(userRoles[group]) &amp;&amp; _.some(roles, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">role</span>) </span>{
                            <span class="hljs-keyword">return</span> _.contains(userRoles[group], role)
                        })
                    <span class="hljs-keyword">if</span> (!found) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24"></a>
</div>
<p>not found in regular group or group not specified.
check Roles.GLOBAL_GROUP, if it exists</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                        found = _.isArray(userRoles[Roles.GLOBAL_GROUP]) &amp;&amp; _.some(roles, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">role</span>) </span>{
                                <span class="hljs-keyword">return</span> _.contains(userRoles[Roles.GLOBAL_GROUP], role)
                            })
                    }
                    <span class="hljs-keyword">return</span> found
                }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25"></a>
</div>
<p>missing roles field, try going direct via id</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                id = user._id
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">'string'</span> === <span class="hljs-keyword">typeof</span> user) {
                id = user
            }

            <span class="hljs-keyword">if</span> (!id) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>


            query = {<span class="hljs-attr">_id</span>: id, <span class="hljs-attr">$or</span>: []}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26"></a>
</div>
<p>always check Roles.GLOBAL_GROUP</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            groupQuery = {}
            groupQuery[<span class="hljs-string">'roles.'</span> + Roles.GLOBAL_GROUP] = {<span class="hljs-attr">$in</span>: roles}
            query.$or.push(groupQuery)

            <span class="hljs-keyword">if</span> (group) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27"></a>
</div>
<p>structure of query, when group specified including Roles.GLOBAL_GROUP
{_id: id,
$or: [
{'roles.group1':{$in: ['admin']}},
{'roles.<strong>global_roles</strong>':{$in: ['admin']}}
]}</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                groupQuery = {}
                groupQuery[<span class="hljs-string">'roles.'</span> + group] = {<span class="hljs-attr">$in</span>: roles}
                query.$or.push(groupQuery)
            } <span class="hljs-keyword">else</span> {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28"></a>
</div>
<p>structure of query, where group not specified. includes
Roles.GLOBAL_GROUP
{_id: id,
$or: [
{roles: {$in: ['admin']}},
{'roles.<strong>global_roles</strong>': {$in: ['admin']}}
]}</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                query.$or.push({<span class="hljs-attr">roles</span>: {<span class="hljs-attr">$in</span>: roles}})
            }

            found = Meteor.users.findOne(query, {<span class="hljs-attr">fields</span>: {<span class="hljs-attr">_id</span>: <span class="hljs-number">1</span>}})
            <span class="hljs-keyword">return</span> found ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>
        },

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29"></a>
</div>
<div class="dox">
<div class="summary">
<p>Retrieve users roles</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">user</span>
<span class="dox_type">String</span>
<span class="dox_type">Object</span>
<span>User Id or actual user object
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">[group]</span>
<span class="dox_type">String</span>
<span>Optional name of group to restrict roles to.                         User's Roles.GLOBAL_GROUP will also be included.
</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span class="dox_type">Array</span>
<span>Array of user's roles, unsorted.
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">        getRolesForUser: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">user, group</span>) </span>{
            <span class="hljs-keyword">if</span> (!user) <span class="hljs-keyword">return</span> []
            <span class="hljs-keyword">if</span> (group) {
                <span class="hljs-keyword">if</span> (<span class="hljs-string">'string'</span> !== <span class="hljs-keyword">typeof</span> group) <span class="hljs-keyword">return</span> []
                <span class="hljs-keyword">if</span> (<span class="hljs-string">'$'</span> === group[<span class="hljs-number">0</span>]) <span class="hljs-keyword">return</span> []

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30"></a>
</div>
<p>convert any periods to underscores</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                group = group.replace(<span class="hljs-regexp">/\./g</span>, <span class="hljs-string">'_'</span>)
            }

            <span class="hljs-keyword">if</span> (<span class="hljs-string">'string'</span> === <span class="hljs-keyword">typeof</span> user) {
                user = Meteor.users.findOne(
                    {<span class="hljs-attr">_id</span>: user},
                    {<span class="hljs-attr">fields</span>: {<span class="hljs-attr">roles</span>: <span class="hljs-number">1</span>}})

            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">'object'</span> !== <span class="hljs-keyword">typeof</span> user) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31"></a>
</div>
<p>invalid user object</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                <span class="hljs-keyword">return</span> []
            }

            <span class="hljs-keyword">if</span> (!user || !user.roles) <span class="hljs-keyword">return</span> []

            <span class="hljs-keyword">if</span> (group) {
                <span class="hljs-keyword">return</span> _.union(user.roles[group] || [], user.roles[Roles.GLOBAL_GROUP] || [])
            }

            <span class="hljs-keyword">if</span> (_.isArray(user.roles))
                <span class="hljs-keyword">return</span> user.roles

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32"></a>
</div>
<p>using groups but group not specified. return global group, if exists</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            <span class="hljs-keyword">return</span> user.roles[Roles.GLOBAL_GROUP] || []
        },

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-33" id="section-33"></a>
</div>
<div class="dox">
<div class="summary">
<p>Retrieve set of all existing roles</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span class="dox_type">Cursor</span>
<span>cursor of existing roles
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">        getAllRoles: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">return</span> Meteor.roles.find({}, {<span class="hljs-attr">sort</span>: {<span class="hljs-attr">name</span>: <span class="hljs-number">1</span>}})
        },

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34"></a>
</div>
<div class="dox">
<div class="summary">
<p>Retrieve all users who are in target role.</p>
<p>NOTE: This is an expensive query; it performs a full collection scan
on the users collection since there is no index set on the 'roles' field.
This is by design as most queries will specify an _id so the _id index is
used automatically.</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">role</span>
<span class="dox_type">Array</span>
<span class="dox_type">String</span>
<span>Name of role/permission. If array, users                            returned will have at least one of the roles
specified but need not have <em>all</em> roles.
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">[group]</span>
<span class="dox_type">String</span>
<span>Optional name of group to restrict roles to.                         User's Roles.GLOBAL_GROUP will also be checked.
</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span class="dox_type">Cursor</span>
<span>cursor of users in role
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">        getUsersInRole: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">role, group</span>) </span>{
            <span class="hljs-keyword">var</span> query,
                roles = role,
                groupQuery

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-35" id="section-35"></a>
</div>
<p>ensure array to simplify query logic</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            <span class="hljs-keyword">if</span> (!_.isArray(roles)) roles = [roles]

            <span class="hljs-keyword">if</span> (group) {
                <span class="hljs-keyword">if</span> (<span class="hljs-string">'string'</span> !== <span class="hljs-keyword">typeof</span> group)
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Roles error: Invalid parameter 'group'. Expected 'string' type"</span>)
                <span class="hljs-keyword">if</span> (<span class="hljs-string">'$'</span> === group[<span class="hljs-number">0</span>])
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Roles error: groups can not start with '$'"</span>)

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-36" id="section-36"></a>
</div>
<p>convert any periods to underscores</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                group = group.replace(<span class="hljs-regexp">/\./g</span>, <span class="hljs-string">'_'</span>)
            }

            query = {<span class="hljs-attr">$or</span>: []}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-37" id="section-37"></a>
</div>
<p>always check Roles.GLOBAL_GROUP</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            groupQuery = {}
            groupQuery[<span class="hljs-string">'roles.'</span> + Roles.GLOBAL_GROUP] = {<span class="hljs-attr">$in</span>: roles}
            query.$or.push(groupQuery)

            <span class="hljs-keyword">if</span> (group) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-38" id="section-38"></a>
</div>
<p>structure of query, when group specified including Roles.GLOBAL_GROUP
{
$or: [
{'roles.group1':{$in: ['admin']}},
{'roles.<strong>global_roles</strong>':{$in: ['admin']}}
]}</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                groupQuery = {}
                groupQuery[<span class="hljs-string">'roles.'</span> + group] = {<span class="hljs-attr">$in</span>: roles}
                query.$or.push(groupQuery)
            } <span class="hljs-keyword">else</span> {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-39" id="section-39"></a>
</div>
<p>structure of query, where group not specified. includes
Roles.GLOBAL_GROUP
{
$or: [
{roles: {$in: ['admin']}},
{'roles.<strong>global_roles</strong>': {$in: ['admin']}}
]}</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                query.$or.push({<span class="hljs-attr">roles</span>: {<span class="hljs-attr">$in</span>: roles}})
            }

            <span class="hljs-keyword">return</span> Meteor.users.find(query)
        },  <span class="hljs-comment">// end getUsersInRole</span>

        getUsersWithPermissions: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">permissions, query, options</span>) </span>{
            <span class="hljs-keyword">var</span> roles;

            <span class="hljs-keyword">if</span> (!_.isArray(permissions)) permissions = [permissions];

            roles = _.map(Meteor.roles.find({<span class="hljs-attr">subRoles</span>: {<span class="hljs-attr">$in</span>: permissions}}).fetch(), <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) </span>{
                <span class="hljs-keyword">return</span> e.name;
            });
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.getUsersInRole(roles, query, options);
        },

        <span class="hljs-attr">getUserIfHasPermission</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">permission, userId</span>) </span>{
            <span class="hljs-keyword">var</span> result;
            <span class="hljs-keyword">var</span> user = <span class="hljs-literal">null</span>;
            <span class="hljs-keyword">if</span> (_.isObject(userId)) {
                user = userId
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (_.isString(userId)) {
                user = Meteor.users.findOne({<span class="hljs-attr">_id</span>: userId});
            }
            <span class="hljs-keyword">else</span> {
                user = Meteor.users.findOne({<span class="hljs-attr">_id</span>: <span class="hljs-keyword">this</span>.userId});
            }

            <span class="hljs-keyword">if</span> (!user)
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

            <span class="hljs-keyword">var</span> rolesToSearch = _.keys(user.roles || {});

            <span class="hljs-keyword">if</span> (_.isString(permission))
                permission = [permission];

            result = Meteor.roles.findOne({<span class="hljs-attr">name</span>: {<span class="hljs-attr">$in</span>: rolesToSearch}, <span class="hljs-attr">subRoles</span>: {<span class="hljs-attr">$in</span>: permission}});

            <span class="hljs-keyword">if</span> (!!result) <span class="hljs-keyword">return</span> user; <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        },

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-40" id="section-40"></a>
</div>
<div class="dox">
<div class="summary">
<p>Retrieve users groups, if any</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">user</span>
<span class="dox_type">String</span>
<span class="dox_type">Object</span>
<span>User Id or actual user object
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">[role]</span>
<span class="dox_type">String</span>
<span>Optional name of roles to restrict groups to.
</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span class="dox_type">Array</span>
<span>Array of user's groups, unsorted. Roles.GLOBAL_GROUP will be omitted
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">        getGroupsForUser: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">user, role</span>) </span>{
            <span class="hljs-keyword">var</span> userGroups = [];

            <span class="hljs-keyword">if</span> (!user) <span class="hljs-keyword">return</span> []
            <span class="hljs-keyword">if</span> (role) {
                <span class="hljs-keyword">if</span> (<span class="hljs-string">'string'</span> !== <span class="hljs-keyword">typeof</span> role) <span class="hljs-keyword">return</span> []
                <span class="hljs-keyword">if</span> (<span class="hljs-string">'$'</span> === role[<span class="hljs-number">0</span>]) <span class="hljs-keyword">return</span> []

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-41" id="section-41"></a>
</div>
<p>convert any periods to underscores</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                role = role.replace(<span class="hljs-string">'.'</span>, <span class="hljs-string">'_'</span>)
            }

            <span class="hljs-keyword">if</span> (<span class="hljs-string">'string'</span> === <span class="hljs-keyword">typeof</span> user) {
                user = Meteor.users.findOne(
                    {<span class="hljs-attr">_id</span>: user},
                    {<span class="hljs-attr">fields</span>: {<span class="hljs-attr">roles</span>: <span class="hljs-number">1</span>}})

            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">'object'</span> !== <span class="hljs-keyword">typeof</span> user) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-42" id="section-42"></a>
</div>
<p>invalid user object</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                <span class="hljs-keyword">return</span> []
            }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-43" id="section-43"></a>
</div>
<p>User has no roles or is not using groups</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            <span class="hljs-keyword">if</span> (!user || !user.roles || _.isArray(user.roles)) <span class="hljs-keyword">return</span> []

            <span class="hljs-keyword">if</span> (role) {
                _.each(user.roles, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">groupRoles, groupName</span>) </span>{
                    <span class="hljs-keyword">if</span> (_.contains(groupRoles, role) &amp;&amp; groupName !== Roles.GLOBAL_GROUP) {
                        userGroups.push(groupName);
                    }
                });
                <span class="hljs-keyword">return</span> userGroups;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> _.without(_.keys(user.roles), Roles.GLOBAL_GROUP);
            }

        }, <span class="hljs-comment">//End getGroupsForUser</span>


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-44" id="section-44"></a>
</div>
<div class="dox">
<div class="summary">
<p>Private function 'template' that uses $set to construct an update object
for MongoDB.  Passed to _updateUserRoles</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">roles</span>
<span class="dox_type">Array</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">[group]</span>
<span class="dox_type">String</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span class="dox_type">Object</span>
<span>update object for use in MongoDB update command
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">        _update_$set_fn: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">roles, group</span>) </span>{
            <span class="hljs-keyword">var</span> update = {}

            <span class="hljs-keyword">if</span> (group) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-45" id="section-45"></a>
</div>
<p>roles is a key/value dict object</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                update.$set = {}
                update.$set[<span class="hljs-string">'roles.'</span> + group] = roles
            } <span class="hljs-keyword">else</span> {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-46" id="section-46"></a>
</div>
<p>roles is an array of strings</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                update.$set = {<span class="hljs-attr">roles</span>: roles}
            }

            <span class="hljs-keyword">return</span> update
        },  <span class="hljs-comment">// end _update_$set_fn</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-47" id="section-47"></a>
</div>
<div class="dox">
<div class="summary">
<p>Private function 'template' that uses $addToSet to construct an update
object for MongoDB.  Passed to _updateUserRoles</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">roles</span>
<span class="dox_type">Array</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">[group]</span>
<span class="dox_type">String</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span class="dox_type">Object</span>
<span>update object for use in MongoDB update command
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">        _update_$addToSet_fn: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">roles, group</span>) </span>{
            <span class="hljs-keyword">var</span> update = {}

            <span class="hljs-keyword">if</span> (group) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-48" id="section-48"></a>
</div>
<p>roles is a key/value dict object</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                update.$addToSet = {}
                update.$addToSet[<span class="hljs-string">'roles.'</span> + group] = {<span class="hljs-attr">$each</span>: roles}
            } <span class="hljs-keyword">else</span> {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-49" id="section-49"></a>
</div>
<p>roles is an array of strings</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                update.$addToSet = {<span class="hljs-attr">roles</span>: {<span class="hljs-attr">$each</span>: roles}}
            }

            <span class="hljs-keyword">return</span> update
        },  <span class="hljs-comment">// end _update_$addToSet_fn</span>


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-50" id="section-50"></a>
</div>
<div class="dox">
<div class="summary">
<p>Internal function that users the Template pattern to adds or sets roles
for users.</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">users</span>
<span class="dox_type">Array</span>
<span class="dox_type">String</span>
<span>user id(s) or object(s) with an _id field
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">roles</span>
<span class="dox_type">Array</span>
<span class="dox_type">String</span>
<span>name(s) of roles/permissions to add users to
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">group</span>
<span class="dox_type">String</span>
<span>Group name. If not null or undefined, roles will be                         specific to that group.
Group names can not start with '$'.
Periods in names '.' are automatically converted
to underscores.
The special group Roles.GLOBAL_GROUP provides
a convenient way to assign blanket roles/permissions
across all groups.  The roles/permissions in the
Roles.GLOBAL_GROUP group will be automatically
included in checks for any group.
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">updateFactory</span>
<span class="dox_type">Function</span>
<span>Func which returns an update object that                         will be passed to Mongo.
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">roles</span>
<span class="dox_type">Array</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">[group]</span>
<span class="dox_type">String</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">        _updateUserRoles: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">users, roles, group, updateFactory</span>) </span>{
            <span class="hljs-keyword">if</span> (!users) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Missing 'users' param"</span>)
            <span class="hljs-keyword">if</span> (!roles) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Missing 'roles' param"</span>)
            <span class="hljs-keyword">if</span> (group) {
                <span class="hljs-keyword">if</span> (<span class="hljs-string">'string'</span> !== <span class="hljs-keyword">typeof</span> group)
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Roles error: Invalid parameter 'group'. Expected 'string' type"</span>)
                <span class="hljs-keyword">if</span> (<span class="hljs-string">'$'</span> === group[<span class="hljs-number">0</span>])
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Roles error: groups can not start with '$'"</span>)

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-51" id="section-51"></a>
</div>
<p>convert any periods to underscores</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                group = group.replace(<span class="hljs-regexp">/\./g</span>, <span class="hljs-string">'_'</span>)
            }

            <span class="hljs-keyword">var</span> existingRoles,
                query,
                update

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-52" id="section-52"></a>
</div>
<p>ensure arrays to simplify code</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            <span class="hljs-keyword">if</span> (!_.isArray(users)) users = [users]
            <span class="hljs-keyword">if</span> (!_.isArray(roles)) roles = [roles]

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-53" id="section-53"></a>
</div>
<p>remove invalid roles</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            roles = _.reduce(roles, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">memo, role</span>) </span>{
                <span class="hljs-keyword">if</span> (role
                    &amp;&amp; <span class="hljs-string">'string'</span> === <span class="hljs-keyword">typeof</span> role
                    &amp;&amp; role.trim().length &gt; <span class="hljs-number">0</span>) {
                    memo.push(role.trim())
                }
                <span class="hljs-keyword">return</span> memo
            }, [])

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-54" id="section-54"></a>
</div>
<p>empty roles array is ok, since it might be a $set operation to clear roles
if (roles.length === 0) return</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-55" id="section-55"></a>
</div>
<p>ensure all roles exist in 'roles' collection</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            existingRoles = _.reduce(Meteor.roles.find({}).fetch(), <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">memo, role</span>) </span>{
                memo[role.name] = <span class="hljs-literal">true</span>
                <span class="hljs-keyword">return</span> memo
            }, {})
            _.each(roles, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">role</span>) </span>{
                <span class="hljs-keyword">if</span> (!existingRoles[role]) {
                    Roles.createRole(role)
                }
            })

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-56" id="section-56"></a>
</div>
<p>ensure users is an array of user ids</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            users = _.reduce(users, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">memo, user</span>) </span>{
                <span class="hljs-keyword">var</span> _id
                <span class="hljs-keyword">if</span> (<span class="hljs-string">'string'</span> === <span class="hljs-keyword">typeof</span> user) {
                    memo.push(user)
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">'object'</span> === <span class="hljs-keyword">typeof</span> user) {
                    _id = user._id
                    <span class="hljs-keyword">if</span> (<span class="hljs-string">'string'</span> === <span class="hljs-keyword">typeof</span> _id) {
                        memo.push(_id)
                    }
                }
                <span class="hljs-keyword">return</span> memo
            }, [])

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-57" id="section-57"></a>
</div>
<p>update all users</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            update = updateFactory(roles, group)

            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">if</span> (Meteor.isClient) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-58" id="section-58"></a>
</div>
<p>On client, iterate over each user to fulfill Meteor's
'one update per ID' policy</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                    _.each(users, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">user</span>) </span>{
                        Meteor.users.update({<span class="hljs-attr">_id</span>: user}, update)
                    })
                } <span class="hljs-keyword">else</span> {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-59" id="section-59"></a>
</div>
<p>On the server we can use MongoDB's $in operator for
better performance</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                    Meteor.users.update(
                        {<span class="hljs-attr">_id</span>: {<span class="hljs-attr">$in</span>: users}},
                        update,
                        {<span class="hljs-attr">multi</span>: <span class="hljs-literal">true</span>})
                }
            }
            <span class="hljs-keyword">catch</span> (ex) {
                <span class="hljs-keyword">var</span> addNonGroupToGroupedRolesMsg = <span class="hljs-string">'Cannot apply $addToSet modifier to non-array'</span>,
                    addGrouped2NonGroupedMsg = <span class="hljs-string">"can't append to array using string field name"</span>

                <span class="hljs-keyword">if</span> (ex.name === <span class="hljs-string">'MongoError'</span> &amp;&amp;
                    (ex.err === addNonGroupToGroupedRolesMsg ||
                    ex.err.substring(<span class="hljs-number">0</span>, <span class="hljs-number">45</span>) === addGrouped2NonGroupedMsg)) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(mixingGroupAndNonGroupErrorMsg)
                }

                <span class="hljs-keyword">throw</span> ex
            }
        }  <span class="hljs-comment">// end _updateUserRoles</span>

    })  <span class="hljs-comment">// end _.extend(Roles ...)</span>

}());

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
