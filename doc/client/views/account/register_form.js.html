<!DOCTYPE html>
<html>
<head>
  <title>register_form.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../doc-style.css" />
  <script src="../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../";
    var thisFile = "client\\views\\account\\register_form.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../doc-script.js"></script>

  <script src="../../../fileSearch.js"></script>

  <link rel="stylesheet" href="../../../fileSearch.css" />

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

      <div class="heading h2">
        <a href="#registration-form">Registration form</a>
      </div>

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="registration-form">
  <h2>
    <a href="#registration-form" name="registration-form" class="pilcrow"></a>
Registration form
  </h2>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">
Template.registerForm.rendered = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> users=Users.find({<span class="hljs-string">'profile.userType'</span>:USERTYPE.CZLONEK});
    <span class="hljs-keyword">if</span>(users.count()&gt;=<span class="hljs-number">5</span>)
        <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">"submitRegistration"</span>).disabled = <span class="hljs-literal">false</span>;
    $(<span class="hljs-string">'#dataUrodzeniaDatePicker'</span>).datetimepicker({
        <span class="hljs-attr">sideBySide</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">format</span>: <span class="hljs-string">'DD/MM/YYYY'</span>
    });
    $(<span class="hljs-string">"#userForm"</span>).validate({
        <span class="hljs-attr">rules</span>: {
            <span class="hljs-attr">password</span>: {
                <span class="hljs-attr">minlength</span>: <span class="hljs-number">6</span>
            },
            <span class="hljs-attr">email</span>: {
                <span class="hljs-attr">email</span>: <span class="hljs-literal">true</span>
            },
            <span class="hljs-attr">confirmPassword</span>: {
                <span class="hljs-attr">equalTo</span>: <span class="hljs-string">"#inputPassword"</span>
            },
            <span class="hljs-attr">pesel</span>:{
                <span class="hljs-attr">exactlength</span>: <span class="hljs-number">11</span>,
                <span class="hljs-attr">peselValidation</span>:<span class="hljs-literal">true</span>,
                <span class="hljs-attr">peselValidation2</span>:<span class="hljs-literal">true</span>
            },
            <span class="hljs-attr">ZipCode</span>:{
                <span class="hljs-attr">kodPocztowyValidation</span>:<span class="hljs-literal">true</span>
            },
            <span class="hljs-attr">language</span>:{
                <span class="hljs-attr">isNotEmptyValue</span>:<span class="hljs-literal">true</span>
            }
        },
        <span class="hljs-attr">messages</span>: {
            <span class="hljs-attr">role</span>: {
                <span class="hljs-attr">required</span>: fieldEmptyMessage()
            },
            <span class="hljs-attr">email</span>: {
                <span class="hljs-attr">required</span>: fieldEmptyMessage(),
                <span class="hljs-attr">email</span>: validEmailMessage()
            },
            <span class="hljs-attr">firstName</span>: {
                <span class="hljs-attr">required</span>: fieldEmptyMessage()
            },
            <span class="hljs-attr">lastName</span>: {
                <span class="hljs-attr">required</span>: fieldEmptyMessage()
            },
            <span class="hljs-attr">password</span>: {
                <span class="hljs-attr">required</span>: fieldEmptyMessage(),
                <span class="hljs-attr">minlength</span>: minLengthMessage(<span class="hljs-number">6</span>)
            },
            <span class="hljs-attr">confirmPassword</span>: {
                <span class="hljs-attr">equalTo</span>: equalToMessage()
            },
            <span class="hljs-attr">address</span>: {
                <span class="hljs-attr">required</span>: fieldEmptyMessage()
            },
            <span class="hljs-attr">ZipCode</span>: {
                <span class="hljs-attr">required</span>: fieldEmptyMessage()
            },
            <span class="hljs-attr">pesel</span>:{
                <span class="hljs-attr">required</span>:fieldEmptyMessage()
            },
            <span class="hljs-attr">city</span>:{
                <span class="hljs-attr">required</span>:fieldEmptyMessage()
            },
            <span class="hljs-attr">language</span>:{
                <span class="hljs-attr">required</span>:fieldEmptyMessage()
            },
            <span class="hljs-attr">statutConfirmation</span>:{
                <span class="hljs-attr">required</span>:fieldEmptyMessage()
            }
        },
        <span class="hljs-attr">highlight</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">element</span>) </span>{
            highlightFunction(element);
        },
        <span class="hljs-attr">unhighlight</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">element</span>) </span>{
            unhighlightFunction(element);
        },
        <span class="hljs-attr">errorElement</span>: <span class="hljs-string">'span'</span>,
        <span class="hljs-attr">errorClass</span>: <span class="hljs-string">'help-block'</span>,
        <span class="hljs-attr">errorPlacement</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">error, element</span>) </span>{
            <span class="hljs-keyword">if</span>(element.attr(<span class="hljs-string">"name"</span>) == <span class="hljs-string">"statutConfirmation"</span>)
                error.insertAfter(<span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">"statutConfirmationSpan"</span>));
            <span class="hljs-keyword">else</span>
                validationPlacementError(error, element);
        }
    })
};

Template.registerForm.events({
    <span class="hljs-string">'submit form'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) </span>{
        e.preventDefault();
        <span class="hljs-keyword">if</span> ($(<span class="hljs-string">'#userForm'</span>).valid()) {
            <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">"submitRegistration"</span>).disabled = <span class="hljs-literal">true</span>;
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>supplement the temporary table with the form data</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            <span class="hljs-keyword">var</span> firstName = $(e.target).find(<span class="hljs-string">'[name=firstName]'</span>).val();
            <span class="hljs-keyword">var</span> lastName = $(e.target).find(<span class="hljs-string">'[name=lastName]'</span>).val();
            <span class="hljs-keyword">var</span> email = $(e.target).find(<span class="hljs-string">'[name=email]'</span>).val();
            Meteor.call(<span class="hljs-string">'serverCheckExistsUser'</span>, email, USERTYPE.CZLONEK, <span class="hljs-literal">null</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">error, ret</span>) </span>{
                <span class="hljs-keyword">if</span> (error) {
                    throwError(error.reason);
                }
                <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">if</span> (ret == <span class="hljs-literal">false</span>) {
                        Meteor.call(<span class="hljs-string">"serverCheckExistsUserDraft"</span>, email, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">error, ret</span>) </span>{
                            <span class="hljs-keyword">if</span> (error) {
                                throwError(error.reason);
                            }
                            <span class="hljs-keyword">else</span> {
                                <span class="hljs-keyword">if</span> (ret == <span class="hljs-literal">false</span>) {
                                    Meteor.call(<span class="hljs-string">"serverGenerateLogin"</span>, firstName, lastName, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, ret</span>) </span>{
                                        <span class="hljs-keyword">if</span> (!err) {
                                            <span class="hljs-keyword">var</span> newUser = [
                                                {
                                                    <span class="hljs-attr">email</span>: email,
                                                    <span class="hljs-attr">login</span>: <span class="hljs-string">""</span>,
                                                    <span class="hljs-attr">firstName</span>: firstName,
                                                    <span class="hljs-attr">lastName</span>: lastName,
                                                    <span class="hljs-attr">password</span>: $(e.target).find(<span class="hljs-string">'[name=password]'</span>).val(),
                                                    <span class="hljs-attr">confirm_password</span>: $(e.target).find(<span class="hljs-string">'[name=confirmPassword]'</span>).val(),
                                                    <span class="hljs-attr">address</span>: $(e.target).find(<span class="hljs-string">'[name=address]'</span>).val(),
                                                    <span class="hljs-attr">zip</span>: $(e.target).find(<span class="hljs-string">'[name=ZipCode]'</span>).val(),
                                                    <span class="hljs-attr">role</span>: <span class="hljs-string">'user'</span>,
                                                    <span class="hljs-attr">userType</span>: USERTYPE.CZLONEK,
                                                    <span class="hljs-attr">uwagi</span>: $(e.target).find(<span class="hljs-string">'[name=uwagi]'</span>).val(),
                                                    <span class="hljs-attr">language</span>: $(e.target).find(<span class="hljs-string">'[name=language]'</span>).val(),
                                                    <span class="hljs-attr">city</span>: $(e.target).find(<span class="hljs-string">'[name=city]'</span>).val(),
                                                    <span class="hljs-attr">pesel</span>: $(e.target).find(<span class="hljs-string">'[name=pesel]'</span>).val()
                                                }];
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>generating a login for the user</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                                            newUser[<span class="hljs-number">0</span>].login = ret;
                                            newUser[<span class="hljs-number">0</span>].fullName = newUser[<span class="hljs-number">0</span>].firstName + <span class="hljs-string">" "</span> + newUser[<span class="hljs-number">0</span>].lastName;
                                            <span class="hljs-keyword">var</span> users=Users.find({<span class="hljs-string">'profile.userType'</span>:USERTYPE.CZLONEK});
                                            <span class="hljs-keyword">if</span>(users.count()&lt;<span class="hljs-number">5</span>) {
                                                Meteor.call(<span class="hljs-string">'addUser'</span>, newUser, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">error, ret</span>) </span>{
                                                    <span class="hljs-keyword">if</span> (error) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>optionally use a meteor errors package</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                                                        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> Errors === <span class="hljs-string">"undefined"</span>)
                                                            Log.error(<span class="hljs-string">'Error: '</span> + error.reason);
                                                        <span class="hljs-keyword">else</span> {
                                                            throwError(error.reason);
                                                        }
                                                    }
                                                    <span class="hljs-keyword">else</span> {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>if correct data</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                                                        <span class="hljs-keyword">var</span> addedUser = ret;
                                                        Meteor.loginWithPassword(newUser[<span class="hljs-number">0</span>].login, newUser[<span class="hljs-number">0</span>].password, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
                                                            <span class="hljs-keyword">if</span> (err) {
                                                                throwError(TAPi18n.__(<span class="hljs-string">'txv.INCOR_LOGIN_DET'</span>));
                                                            } <span class="hljs-keyword">else</span> {
                                                                <span class="hljs-keyword">var</span> zespol = ZespolRealizacyjny.findOne({<span class="hljs-attr">_id</span>: <span class="hljs-string">"jjXKur4qC5ZGPQkgN"</span>});
                                                                <span class="hljs-keyword">if</span> (zespol) {
                                                                    <span class="hljs-keyword">if</span> (zespol.zespol.length &lt; <span class="hljs-number">3</span>) {
                                                                        <span class="hljs-keyword">var</span> ZR = zespol.zespol.slice();
                                                                        ZR.push(addedUser);

                                                                        <span class="hljs-keyword">if</span> (zespol.zespol.length == <span class="hljs-number">0</span>) {
                                                                            Meteor.call(<span class="hljs-string">'updateCzlonkowieZRProtector'</span>, zespol._id, ZR, addedUser, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">error, ret</span>) </span>{
                                                                                <span class="hljs-keyword">if</span> (error) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>optionally use a meteor errors package</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                                                                                    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> Errors === <span class="hljs-string">"undefined"</span>)
                                                                                        Log.error(TAPi18n.__(<span class="hljs-string">'txv.ERROR'</span>) + error.reason);
                                                                                    <span class="hljs-keyword">else</span> {
                                                                                        throwError(error.reason);
                                                                                    }
                                                                                }
                                                                            });
                                                                        }
                                                                        <span class="hljs-keyword">else</span> {
                                                                            Meteor.call(<span class="hljs-string">'updateCzlonkowieZR'</span>, zespol._id, ZR, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">error, ret</span>) </span>{
                                                                                <span class="hljs-keyword">if</span> (error) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>optionally use a meteor errors package</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                                                                                    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> Errors === <span class="hljs-string">"undefined"</span>)
                                                                                        Log.error(TAPi18n.__(<span class="hljs-string">'txv.ERROR'</span>) + error.reason);
                                                                                    <span class="hljs-keyword">else</span> {
                                                                                        throwError(error.reason);
                                                                                    }
                                                                                }
                                                                            });
                                                                        }
                                                                    }
                                                                }
                                                                <span class="hljs-keyword">if</span> (Meteor.loggingIn()) {
                                                                    Router.go(<span class="hljs-string">'home'</span>);
                                                                }
                                                                bootbox.dialog({
                                                                    <span class="hljs-attr">message</span>: TAPi18n.__(<span class="hljs-string">'txv.YOUR_LOGIN'</span>) + newUser[<span class="hljs-number">0</span>].login,
                                                                    <span class="hljs-attr">title</span>: TAPi18n.__(<span class="hljs-string">'txv.HELLO'</span>) + newUser[<span class="hljs-number">0</span>].firstName,
                                                                    <span class="hljs-attr">buttons</span>: {
                                                                        <span class="hljs-attr">main</span>: {
                                                                            <span class="hljs-attr">label</span>: TAPi18n.__(<span class="hljs-string">'txv.OK'</span>),
                                                                            <span class="hljs-attr">className</span>: <span class="hljs-string">"btn-primary"</span>
                                                                        }
                                                                    }
                                                                });
                                                            }
                                                        });

                                                    }
                                                });
                                            }
                                            <span class="hljs-keyword">else</span>{
                                                bootbox.alert(TAPi18n.__(<span class="hljs-string">'txv.REG_NOT_POSS'</span>))
                                            }
                                        } <span class="hljs-keyword">else</span> {
                                            throwError(err.reason)
                                        }
                                    });
                                }
                                <span class="hljs-keyword">else</span> {
                                    throwError(TAPi18n.__(<span class="hljs-string">'txv.ACCESS_EXIST'</span>));
                                    <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">"submitRegistration"</span>).disabled = <span class="hljs-literal">false</span>;
                                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
                                }
                            }
                        });
                    }
                    <span class="hljs-keyword">else</span> {
                        throwError(TAPi18n.__(<span class="hljs-string">'txv.USER_EXIST'</span>));
                        <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">"submitRegistration"</span>).disabled = <span class="hljs-literal">false</span>;
                        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
                    }
                }
            });
        }
    },
    <span class="hljs-string">'reset form'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        Router.go(<span class="hljs-string">'listUsers'</span>);
    },
    <span class="hljs-string">'click #statutBootbox'</span>:<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
        bootbox.dialog({
            <span class="hljs-attr">message</span>: getRegulamin(),
            <span class="hljs-attr">title</span>: TAPi18n.__(<span class="hljs-string">'txv.RULES_OF_THE_ORGANIZATION'</span>) + getNazwaOrganizacji(),
            <span class="hljs-attr">buttons</span>: {
                <span class="hljs-attr">main</span>: {
                    <span class="hljs-attr">label</span>: TAPi18n.__(<span class="hljs-string">'txv.OK'</span>),
                    <span class="hljs-attr">className</span>: <span class="hljs-string">"btn-primary"</span>
                }
            }
        });
    }
});

Template.registerForm.helpers({
    <span class="hljs-string">'lessThanFiveUsers'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> users = Users.find({<span class="hljs-string">'profile.userType'</span>:USERTYPE.CZLONEK});
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>var users=Users.find();</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">return</span> !!users &amp;&amp; users.count() &lt; <span class="hljs-number">5</span> ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;
    },
    <span class="hljs-string">'getLanguages'</span>:<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
        <span class="hljs-keyword">return</span> Languages.find({}).map(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">lang</span>) </span>{
            <span class="hljs-keyword">return</span> {
                <span class="hljs-attr">shortName</span>: lang.shortName,
                <span class="hljs-attr">languageName</span>: TAPi18n.__(<span class="hljs-string">'listLanguages.'</span> + lang.languageName)
            };
        });
    }
});

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
