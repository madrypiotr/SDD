<!DOCTYPE html>
<html>
<head>
  <title>login_buttons_dropdown.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../doc-style.css" />
  <script src="../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../";
    var thisFile = "packages\\meteor-accounts-ui-bootstrap-3\\login_buttons_dropdown.js";
    var defaultSidebar = true;
  </script>
  <script src="../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>login_buttons_dropdown.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>for convenience</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">	<span class="hljs-keyword">var</span> loginButtonsSession = Accounts._loginButtonsSession;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>events shared between loginButtonsLoggedOutDropdown and
loginButtonsLoggedInDropdown</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">	Template._loginButtons.events({
		<span class="hljs-string">'click input'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>)</span>{
			event.stopPropagation();
		},
		<span class="hljs-string">'click #login-name-link, click #login-sign-in-link'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
			event.stopPropagation();
			loginButtonsSession.set(<span class="hljs-string">'dropdownVisible'</span>, <span class="hljs-literal">true</span>);
			Meteor.flush();
		},
		<span class="hljs-string">'click .login-close'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
			loginButtonsSession.closeDropdown();
		}
	});

	Template._loginButtons.toggleDropdown = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
		toggleDropdown();
	};

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>loginButtonsLoggedInDropdown template and related</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
	Template._loginButtonsLoggedInDropdown.events({
		<span class="hljs-string">'click #login-buttons-open-change-password'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
			event.stopPropagation();
			loginButtonsSession.resetMessages();
			loginButtonsSession.set(<span class="hljs-string">'inChangePasswordFlow'</span>, <span class="hljs-literal">true</span>);
			Meteor.flush();
		}
	});

	Template._loginButtonsLoggedInDropdown.displayName = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
		<span class="hljs-keyword">return</span> Accounts._loginButtons.displayName();
	};

	Template._loginButtonsLoggedInDropdown.inChangePasswordFlow = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
		<span class="hljs-keyword">return</span> loginButtonsSession.get(<span class="hljs-string">'inChangePasswordFlow'</span>);
	};

	Template._loginButtonsLoggedInDropdown.inMessageOnlyFlow = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
		<span class="hljs-keyword">return</span> loginButtonsSession.get(<span class="hljs-string">'inMessageOnlyFlow'</span>);
	};

	Template._loginButtonsLoggedInDropdown.dropdownVisible = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
		<span class="hljs-keyword">return</span> loginButtonsSession.get(<span class="hljs-string">'dropdownVisible'</span>);
	};

	Template._loginButtonsLoggedInDropdownActions.allowChangingPassword = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>it would be more correct to check whether the user has a password set,
but in order to do that we'd have to send more data down to the client,
and it'd be preferable not to send down the entire service.password document.</p>
<p>instead we use the heuristic: if the user has a username or email set.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">		<span class="hljs-keyword">var</span> user = Meteor.user();
		<span class="hljs-keyword">return</span> user.username || (user.emails &amp;&amp; user.emails[<span class="hljs-number">0</span>] &amp;&amp; user.emails[<span class="hljs-number">0</span>].address);
	};


	Template._loginButtonsLoggedInDropdownActions.additionalLoggedInDropdownActions = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
	  <span class="hljs-keyword">return</span> Template._loginButtonsAdditionalLoggedInDropdownActions !== <span class="hljs-literal">undefined</span>;
	};

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>loginButtonsLoggedOutDropdown template and related</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
	Template._loginButtonsLoggedOutDropdown.events({
		<span class="hljs-string">'click #login-buttons-password'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
			event.stopPropagation();
			loginOrSignup();
		},

		<span class="hljs-string">'keypress #forgot-password-email'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
			event.stopPropagation();
			<span class="hljs-keyword">if</span> (event.keyCode === <span class="hljs-number">13</span>)
				forgotPassword();
		},

		<span class="hljs-string">'click #login-buttons-forgot-password'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
			event.stopPropagation();
			forgotPassword();
		},

		<span class="hljs-string">'click #signup-link'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
			event.stopPropagation();
			loginButtonsSession.resetMessages();

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>store values of fields before swtiching to the signup form</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">			<span class="hljs-keyword">var</span> username = trimmedElementValueById(<span class="hljs-string">'login-username'</span>);
			<span class="hljs-keyword">var</span> email = trimmedElementValueById(<span class="hljs-string">'login-email'</span>);
			<span class="hljs-keyword">var</span> usernameOrEmail = trimmedElementValueById(<span class="hljs-string">'login-username-or-email'</span>);
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>notably not trimmed. a password could (?) start or end with a space</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">			<span class="hljs-keyword">var</span> password = elementValueById(<span class="hljs-string">'login-password'</span>);

			loginButtonsSession.set(<span class="hljs-string">'inSignupFlow'</span>, <span class="hljs-literal">true</span>);
			loginButtonsSession.set(<span class="hljs-string">'inForgotPasswordFlow'</span>, <span class="hljs-literal">false</span>);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>force the ui to update so that we have the approprate fields to fill in</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">			Meteor.flush();

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>update new fields with appropriate defaults</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">			<span class="hljs-keyword">if</span> (username !== <span class="hljs-literal">null</span>)
				<span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'login-username'</span>).value = username;
			<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (email !== <span class="hljs-literal">null</span>)
				<span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'login-email'</span>).value = email;
			<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (usernameOrEmail !== <span class="hljs-literal">null</span>)
				<span class="hljs-keyword">if</span> (usernameOrEmail.indexOf(<span class="hljs-string">'@'</span>) === <span class="hljs-number">-1</span>)
					<span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'login-username'</span>).value = usernameOrEmail;
				<span class="hljs-keyword">else</span>
					<span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'login-email'</span>).value = usernameOrEmail;
		},
		<span class="hljs-string">'click #forgot-password-link'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
			event.stopPropagation();
			loginButtonsSession.resetMessages();

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>store values of fields before swtiching to the signup form</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">			<span class="hljs-keyword">var</span> email = trimmedElementValueById(<span class="hljs-string">'login-email'</span>);
			<span class="hljs-keyword">var</span> usernameOrEmail = trimmedElementValueById(<span class="hljs-string">'login-username-or-email'</span>);

			loginButtonsSession.set(<span class="hljs-string">'inSignupFlow'</span>, <span class="hljs-literal">false</span>);
			loginButtonsSession.set(<span class="hljs-string">'inForgotPasswordFlow'</span>, <span class="hljs-literal">true</span>);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>force the ui to update so that we have the approprate fields to fill in</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">			Meteor.flush();
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>toggleDropdown();</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>update new fields with appropriate defaults</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">			<span class="hljs-keyword">if</span> (email !== <span class="hljs-literal">null</span>)
				<span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'forgot-password-email'</span>).value = email;
			<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (usernameOrEmail !== <span class="hljs-literal">null</span>)
				<span class="hljs-keyword">if</span> (usernameOrEmail.indexOf(<span class="hljs-string">'@'</span>) !== <span class="hljs-number">-1</span>)
					<span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'forgot-password-email'</span>).value = usernameOrEmail;
		},
		<span class="hljs-string">'click #back-to-login-link'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
			event.stopPropagation();
			loginButtonsSession.resetMessages();

			<span class="hljs-keyword">var</span> username = trimmedElementValueById(<span class="hljs-string">'login-username'</span>);
			<span class="hljs-keyword">var</span> email = trimmedElementValueById(<span class="hljs-string">'login-email'</span>) || trimmedElementValueById(<span class="hljs-string">'forgot-password-email'</span>); <span class="hljs-comment">// Ughh. Standardize on names?</span>

			loginButtonsSession.set(<span class="hljs-string">'inSignupFlow'</span>, <span class="hljs-literal">false</span>);
			loginButtonsSession.set(<span class="hljs-string">'inForgotPasswordFlow'</span>, <span class="hljs-literal">false</span>);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<p>force the ui to update so that we have the approprate fields to fill in</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">			Meteor.flush();

			<span class="hljs-keyword">if</span> (<span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'login-username'</span>))
				<span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'login-username'</span>).value = username;
			<span class="hljs-keyword">if</span> (<span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'login-email'</span>))
				<span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'login-email'</span>).value = email;
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<p>&quot;login-password&quot; is preserved thanks to the preserve-inputs package</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">			<span class="hljs-keyword">if</span> (<span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'login-username-or-email'</span>))
				<span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'login-username-or-email'</span>).value = email || username;
		},
		<span class="hljs-string">'keypress #login-username, keypress #login-email, keypress #login-username-or-email, keypress #login-password, keypress #login-password-again'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
			<span class="hljs-keyword">if</span> (event.keyCode === <span class="hljs-number">13</span>)
				loginOrSignup();
		}
	});

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<p>additional classes that can be helpful in styling the dropdown</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">	Template._loginButtonsLoggedOutDropdown.additionalClasses = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
		<span class="hljs-keyword">if</span> (!Accounts.password) {
			<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
		} <span class="hljs-keyword">else</span> {
			<span class="hljs-keyword">if</span> (loginButtonsSession.get(<span class="hljs-string">'inSignupFlow'</span>)) {
				<span class="hljs-keyword">return</span> <span class="hljs-string">'login-form-create-account'</span>;
			} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (loginButtonsSession.get(<span class="hljs-string">'inForgotPasswordFlow'</span>)) {
				<span class="hljs-keyword">return</span> <span class="hljs-string">'login-form-forgot-password'</span>;
			} <span class="hljs-keyword">else</span> {
				<span class="hljs-keyword">return</span> <span class="hljs-string">'login-form-sign-in'</span>;
			}
		}
	};

	Template._loginButtonsLoggedOutDropdown.dropdownVisible = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
		<span class="hljs-keyword">return</span> loginButtonsSession.get(<span class="hljs-string">'dropdownVisible'</span>);
	};

	Template._loginButtonsLoggedOutDropdown.hasPasswordService = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
		<span class="hljs-keyword">return</span> Accounts._loginButtons.hasPasswordService();
	};

	Template._loginButtonsLoggedOutDropdown.forbidClientAccountCreation = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
		<span class="hljs-keyword">return</span> Accounts._options.forbidClientAccountCreation;
	};

	Template._loginButtonsLoggedOutAllServices.services = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
		<span class="hljs-keyword">return</span> Accounts._loginButtons.getLoginServices();
	};

	Template._loginButtonsLoggedOutAllServices.isPasswordService = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.name === <span class="hljs-string">'password'</span>;
	};

	Template._loginButtonsLoggedOutAllServices.hasOtherServices = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
		<span class="hljs-keyword">return</span> Accounts._loginButtons.getLoginServices().length &gt; <span class="hljs-number">1</span>;
	};

	Template._loginButtonsLoggedOutAllServices.hasPasswordService = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
		<span class="hljs-keyword">return</span> Accounts._loginButtons.hasPasswordService();
	};

	Template._loginButtonsLoggedOutPasswordService.fields = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
		<span class="hljs-keyword">var</span> loginFields = [{
			<span class="hljs-attr">fieldName</span>: <span class="hljs-string">'username-or-email'</span>,
			<span class="hljs-attr">fieldLabel</span>: <span class="hljs-string">'Username or Email'</span>,
			<span class="hljs-attr">visible</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
				<span class="hljs-keyword">return</span> _.contains(
					[<span class="hljs-string">"USERNAME_AND_EMAIL_CONFIRM"</span>, <span class="hljs-string">"USERNAME_AND_EMAIL"</span>, <span class="hljs-string">"USERNAME_AND_OPTIONAL_EMAIL"</span>],
					Accounts.ui._passwordSignupFields());
			}
		}, {
			<span class="hljs-attr">fieldName</span>: <span class="hljs-string">'username'</span>,
			<span class="hljs-attr">fieldLabel</span>: <span class="hljs-string">'Username'</span>,
			<span class="hljs-attr">visible</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
				<span class="hljs-keyword">return</span> Accounts.ui._passwordSignupFields() === <span class="hljs-string">"USERNAME_ONLY"</span>;
			}
		}, {
			<span class="hljs-attr">fieldName</span>: <span class="hljs-string">'email'</span>,
			<span class="hljs-attr">fieldLabel</span>: <span class="hljs-string">'Email'</span>,
			<span class="hljs-attr">inputType</span>: <span class="hljs-string">'email'</span>,
			<span class="hljs-attr">visible</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
				<span class="hljs-keyword">return</span> Accounts.ui._passwordSignupFields() === <span class="hljs-string">"EMAIL_ONLY"</span>;
			}
		}, {
			<span class="hljs-attr">fieldName</span>: <span class="hljs-string">'password'</span>,
			<span class="hljs-attr">fieldLabel</span>: <span class="hljs-string">'Password'</span>,
			<span class="hljs-attr">inputType</span>: <span class="hljs-string">'password'</span>,
			<span class="hljs-attr">visible</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
				<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
			}
		}];

		<span class="hljs-keyword">var</span> signupFields = [{
			<span class="hljs-attr">fieldName</span>: <span class="hljs-string">'username'</span>,
			<span class="hljs-attr">fieldLabel</span>: <span class="hljs-string">'Username'</span>,
			<span class="hljs-attr">visible</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
				<span class="hljs-keyword">return</span> _.contains(
					[<span class="hljs-string">"USERNAME_AND_EMAIL_CONFIRM"</span>, <span class="hljs-string">"USERNAME_AND_EMAIL"</span>, <span class="hljs-string">"USERNAME_AND_OPTIONAL_EMAIL"</span>, <span class="hljs-string">"USERNAME_ONLY"</span>],
					Accounts.ui._passwordSignupFields());
			}
		}, {
			<span class="hljs-attr">fieldName</span>: <span class="hljs-string">'email'</span>,
			<span class="hljs-attr">fieldLabel</span>: <span class="hljs-string">'Email'</span>,
			<span class="hljs-attr">inputType</span>: <span class="hljs-string">'email'</span>,
			<span class="hljs-attr">visible</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
				<span class="hljs-keyword">return</span> _.contains(
					[<span class="hljs-string">"USERNAME_AND_EMAIL_CONFIRM"</span>, <span class="hljs-string">"USERNAME_AND_EMAIL"</span>, <span class="hljs-string">"EMAIL_ONLY"</span>],
					Accounts.ui._passwordSignupFields());
			}
		}, {
			<span class="hljs-attr">fieldName</span>: <span class="hljs-string">'email'</span>,
			<span class="hljs-attr">fieldLabel</span>: <span class="hljs-string">'Email (optional)'</span>,
			<span class="hljs-attr">inputType</span>: <span class="hljs-string">'email'</span>,
			<span class="hljs-attr">visible</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
				<span class="hljs-keyword">return</span> Accounts.ui._passwordSignupFields() === <span class="hljs-string">"USERNAME_AND_OPTIONAL_EMAIL"</span>;
			}
		}, {
			<span class="hljs-attr">fieldName</span>: <span class="hljs-string">'password'</span>,
			<span class="hljs-attr">fieldLabel</span>: <span class="hljs-string">'Password'</span>,
			<span class="hljs-attr">inputType</span>: <span class="hljs-string">'password'</span>,
			<span class="hljs-attr">visible</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
				<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
			}
		}, {
			<span class="hljs-attr">fieldName</span>: <span class="hljs-string">'password-again'</span>,
			<span class="hljs-attr">fieldLabel</span>: <span class="hljs-string">'Password (again)'</span>,
			<span class="hljs-attr">inputType</span>: <span class="hljs-string">'password'</span>,
			<span class="hljs-attr">visible</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<p>No need to make users double-enter their password if
they'll necessarily have an email set, since they can use
the &quot;forgot password&quot; flow.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">				<span class="hljs-keyword">return</span> _.contains(
					[<span class="hljs-string">"USERNAME_AND_EMAIL_CONFIRM"</span>, <span class="hljs-string">"USERNAME_AND_OPTIONAL_EMAIL"</span>, <span class="hljs-string">"USERNAME_ONLY"</span>],
					Accounts.ui._passwordSignupFields());
			}
		}];

		signupFields = Accounts.ui._options.extraSignupFields.concat(signupFields);

		<span class="hljs-keyword">return</span> loginButtonsSession.get(<span class="hljs-string">'inSignupFlow'</span>) ? signupFields : loginFields;
	};

	Template._loginButtonsLoggedOutPasswordService.inForgotPasswordFlow = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
		<span class="hljs-keyword">return</span> loginButtonsSession.get(<span class="hljs-string">'inForgotPasswordFlow'</span>);
	};

	Template._loginButtonsLoggedOutPasswordService.inLoginFlow = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
		<span class="hljs-keyword">return</span> !loginButtonsSession.get(<span class="hljs-string">'inSignupFlow'</span>) &amp;&amp; !loginButtonsSession.get(<span class="hljs-string">'inForgotPasswordFlow'</span>);
	};

	Template._loginButtonsLoggedOutPasswordService.inSignupFlow = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
		<span class="hljs-keyword">return</span> loginButtonsSession.get(<span class="hljs-string">'inSignupFlow'</span>);
	};

	Template._loginButtonsLoggedOutPasswordService.showForgotPasswordLink = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
		<span class="hljs-keyword">return</span> _.contains(
			[<span class="hljs-string">"USERNAME_AND_EMAIL_CONFIRM"</span>, <span class="hljs-string">"USERNAME_AND_EMAIL"</span>, <span class="hljs-string">"USERNAME_AND_OPTIONAL_EMAIL"</span>, <span class="hljs-string">"EMAIL_ONLY"</span>],
			Accounts.ui._passwordSignupFields());
	};

	Template._loginButtonsLoggedOutPasswordService.showCreateAccountLink = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
		<span class="hljs-keyword">return</span> !Accounts._options.forbidClientAccountCreation;
	};

	Template._loginButtonsFormField.inputType = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.inputType || <span class="hljs-string">"text"</span>;
	};


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<p>loginButtonsChangePassword template</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">	Template._loginButtonsChangePassword.events({
		<span class="hljs-string">'keypress #login-old-password, keypress #login-password, keypress #login-password-again'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
			<span class="hljs-keyword">if</span> (event.keyCode === <span class="hljs-number">13</span>)
				changePassword();
		},
		<span class="hljs-string">'click #login-buttons-do-change-password'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
			event.stopPropagation();
			changePassword();
		},
		<span class="hljs-string">'click #login-buttons-cancel-change-password'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
			event.stopPropagation();
			loginButtonsSession.resetMessages();
			Accounts._loginButtonsSession.set(<span class="hljs-string">'inChangePasswordFlow'</span>, <span class="hljs-literal">false</span>);
			Meteor.flush();
		}
	});

	Template._loginButtonsChangePassword.fields = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
		<span class="hljs-keyword">return</span> [{
			<span class="hljs-attr">fieldName</span>: <span class="hljs-string">'old-password'</span>,
			<span class="hljs-attr">fieldLabel</span>: <span class="hljs-string">'Current Password'</span>,
			<span class="hljs-attr">inputType</span>: <span class="hljs-string">'password'</span>,
			<span class="hljs-attr">visible</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
				<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
			}
		}, {
			<span class="hljs-attr">fieldName</span>: <span class="hljs-string">'password'</span>,
			<span class="hljs-attr">fieldLabel</span>: <span class="hljs-string">'New Password'</span>,
			<span class="hljs-attr">inputType</span>: <span class="hljs-string">'password'</span>,
			<span class="hljs-attr">visible</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
				<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
			}
		}, {
			<span class="hljs-attr">fieldName</span>: <span class="hljs-string">'password-again'</span>,
			<span class="hljs-attr">fieldLabel</span>: <span class="hljs-string">'New Password (again)'</span>,
			<span class="hljs-attr">inputType</span>: <span class="hljs-string">'password'</span>,
			<span class="hljs-attr">visible</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<p>No need to make users double-enter their password if
they'll necessarily have an email set, since they can use
the &quot;forgot password&quot; flow.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">				<span class="hljs-keyword">return</span> _.contains(
					[<span class="hljs-string">"USERNAME_AND_OPTIONAL_EMAIL"</span>, <span class="hljs-string">"USERNAME_ONLY"</span>],
					Accounts.ui._passwordSignupFields());
			}
		}];
	};


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21"></a>
</div>
<p>helpers</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
	<span class="hljs-keyword">var</span> elementValueById = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">id</span>) </span>{
		<span class="hljs-keyword">var</span> element = <span class="hljs-built_in">document</span>.getElementById(id);
		<span class="hljs-keyword">if</span> (!element)
			<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
		<span class="hljs-keyword">else</span>
			<span class="hljs-keyword">return</span> element.value;
	};

	<span class="hljs-keyword">var</span> trimmedElementValueById = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">id</span>) </span>{
		<span class="hljs-keyword">var</span> element = <span class="hljs-built_in">document</span>.getElementById(id);
		<span class="hljs-keyword">if</span> (!element)
			<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
		<span class="hljs-keyword">else</span>
			<span class="hljs-keyword">return</span> element.value.replace(<span class="hljs-regexp">/^\s*|\s*$/g</span>, <span class="hljs-string">""</span>); <span class="hljs-comment">// trim;</span>
	};

	<span class="hljs-keyword">var</span> loginOrSignup = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
		<span class="hljs-keyword">if</span> (loginButtonsSession.get(<span class="hljs-string">'inSignupFlow'</span>))
			signup();
		<span class="hljs-keyword">else</span>
			login();
	};

	<span class="hljs-keyword">var</span> login = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
		loginButtonsSession.resetMessages();

		<span class="hljs-keyword">var</span> username = trimmedElementValueById(<span class="hljs-string">'login-username'</span>);
		<span class="hljs-keyword">var</span> email = trimmedElementValueById(<span class="hljs-string">'login-email'</span>);
		<span class="hljs-keyword">var</span> usernameOrEmail = trimmedElementValueById(<span class="hljs-string">'login-username-or-email'</span>);
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22"></a>
</div>
<p>notably not trimmed. a password could (?) start or end with a space</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">		<span class="hljs-keyword">var</span> password = elementValueById(<span class="hljs-string">'login-password'</span>);

		<span class="hljs-keyword">var</span> loginSelector;
		<span class="hljs-keyword">if</span> (username !== <span class="hljs-literal">null</span>) {
			<span class="hljs-keyword">if</span> (!Accounts._loginButtons.validateUsername(username))
				<span class="hljs-keyword">return</span>;
			<span class="hljs-keyword">else</span>
				loginSelector = {
					<span class="hljs-attr">username</span>: username
				};
		} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (email !== <span class="hljs-literal">null</span>) {
			<span class="hljs-keyword">if</span> (!Accounts._loginButtons.validateEmail(email))
				<span class="hljs-keyword">return</span>;
			<span class="hljs-keyword">else</span>
				loginSelector = {
					<span class="hljs-attr">email</span>: email
				};
		} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (usernameOrEmail !== <span class="hljs-literal">null</span>) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23"></a>
</div>
<p>XXX not sure how we should validate this. but this seems good enough (for now),
since an email must have at least 3 characters anyways</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">			<span class="hljs-keyword">if</span> (!Accounts._loginButtons.validateUsername(usernameOrEmail))
				<span class="hljs-keyword">return</span>;
			<span class="hljs-keyword">else</span>
				loginSelector = usernameOrEmail;
		} <span class="hljs-keyword">else</span> {
			<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Unexpected -- no element to use as a login user selector"</span>);
		}

		Meteor.loginWithPassword(loginSelector, password, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error, result</span>) </span>{
			<span class="hljs-keyword">if</span> (error) {
				loginButtonsSession.errorMessage(error.reason || <span class="hljs-string">"Unknown error"</span>);
			} <span class="hljs-keyword">else</span> {
				loginButtonsSession.closeDropdown();
			}
		});
	};

	<span class="hljs-keyword">var</span> toggleDropdown = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
		$(<span class="hljs-string">'#login-dropdown-list .dropdown-menu'</span>).dropdown(<span class="hljs-string">'toggle'</span>);
	};

	<span class="hljs-keyword">var</span> signup = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
		loginButtonsSession.resetMessages();

		<span class="hljs-keyword">var</span> options = {}; <span class="hljs-comment">// to be passed to Accounts.createUser</span>

		<span class="hljs-keyword">var</span> username = trimmedElementValueById(<span class="hljs-string">'login-username'</span>);
		<span class="hljs-keyword">if</span> (username !== <span class="hljs-literal">null</span>) {
			<span class="hljs-keyword">if</span> (!Accounts._loginButtons.validateUsername(username))
				<span class="hljs-keyword">return</span>;
			<span class="hljs-keyword">else</span>
				options.username = username;
		}

		<span class="hljs-keyword">var</span> email = trimmedElementValueById(<span class="hljs-string">'login-email'</span>);
		<span class="hljs-keyword">if</span> (email !== <span class="hljs-literal">null</span>) {
			<span class="hljs-keyword">if</span> (!Accounts._loginButtons.validateEmail(email))
				<span class="hljs-keyword">return</span>;
			<span class="hljs-keyword">else</span>
				options.email = email;
		}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24"></a>
</div>
<p>notably not trimmed. a password could (?) start or end with a space</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">		<span class="hljs-keyword">var</span> password = elementValueById(<span class="hljs-string">'login-password'</span>);
		<span class="hljs-keyword">if</span> (!Accounts._loginButtons.validatePassword(password))
			<span class="hljs-keyword">return</span>;
		<span class="hljs-keyword">else</span>
			options.password = password;

		<span class="hljs-keyword">if</span> (!matchPasswordAgainIfPresent())
			<span class="hljs-keyword">return</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25"></a>
</div>
<p>prepare the profile object</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">		options.profile = {};

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26"></a>
</div>
<p>define a proxy function to allow extraSignupFields set error messages</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">		<span class="hljs-keyword">var</span> errorFn = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">errorMessage</span>) </span>{
			Accounts._loginButtonsSession.errorMessage(errorMessage);
		};

		<span class="hljs-keyword">var</span> invalidExtraSignupFields = <span class="hljs-literal">false</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27"></a>
</div>
<p>parse extraSignupFields to populate account's profile data</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">		_.each(Accounts.ui._options.extraSignupFields, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">field, index</span>) </span>{
			<span class="hljs-keyword">var</span> value = elementValueById(<span class="hljs-string">'login-'</span> + field.fieldName);
			<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> field.validate === <span class="hljs-string">'function'</span>) {
				<span class="hljs-keyword">if</span> (field.validate(value, errorFn)) {
					options.profile[field.fieldName] = elementValueById(<span class="hljs-string">'login-'</span> + field.fieldName);
				} <span class="hljs-keyword">else</span> {
					invalidExtraSignupFields = <span class="hljs-literal">true</span>;
				}
			} <span class="hljs-keyword">else</span> {
				options.profile[field.fieldName] = elementValueById(<span class="hljs-string">'login-'</span> + field.fieldName);
			}
		});

		<span class="hljs-keyword">if</span> (invalidExtraSignupFields)
			<span class="hljs-keyword">return</span>;

		Accounts.createUser(options, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error</span>) </span>{
			<span class="hljs-keyword">if</span> (error) {
				loginButtonsSession.errorMessage(error.reason || <span class="hljs-string">"Unknown error"</span>);
			} <span class="hljs-keyword">else</span> {
				loginButtonsSession.closeDropdown();
			}
		});
	};

	<span class="hljs-keyword">var</span> forgotPassword = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
		loginButtonsSession.resetMessages();

		<span class="hljs-keyword">var</span> email = trimmedElementValueById(<span class="hljs-string">"forgot-password-email"</span>);
		<span class="hljs-keyword">if</span> (email.indexOf(<span class="hljs-string">'@'</span>) !== <span class="hljs-number">-1</span>) {
			Accounts.forgotPassword({
				<span class="hljs-attr">email</span>: email
			}, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error</span>) </span>{
				<span class="hljs-keyword">if</span> (error)
					loginButtonsSession.errorMessage(error.reason || <span class="hljs-string">"Unknown error"</span>);
				<span class="hljs-keyword">else</span>
					loginButtonsSession.infoMessage(<span class="hljs-string">"Email sent"</span>);
			});
		} <span class="hljs-keyword">else</span> {
			loginButtonsSession.infoMessage(<span class="hljs-string">"Email sent"</span>);
		}
	};

	<span class="hljs-keyword">var</span> changePassword = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
		loginButtonsSession.resetMessages();

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28"></a>
</div>
<p>notably not trimmed. a password could (?) start or end with a space</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">		<span class="hljs-keyword">var</span> oldPassword = elementValueById(<span class="hljs-string">'login-old-password'</span>);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29"></a>
</div>
<p>notably not trimmed. a password could (?) start or end with a space</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">		<span class="hljs-keyword">var</span> password = elementValueById(<span class="hljs-string">'login-password'</span>);
		<span class="hljs-keyword">if</span> (!Accounts._loginButtons.validatePassword(password))
			<span class="hljs-keyword">return</span>;

		<span class="hljs-keyword">if</span> (!matchPasswordAgainIfPresent())
			<span class="hljs-keyword">return</span>;

		Accounts.changePassword(oldPassword, password, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error</span>) </span>{
			<span class="hljs-keyword">if</span> (error) {
				loginButtonsSession.errorMessage(error.reason || <span class="hljs-string">"Unknown error"</span>);
			} <span class="hljs-keyword">else</span> {
				loginButtonsSession.infoMessage(<span class="hljs-string">"Password changed"</span>);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30"></a>
</div>
<p>wait 3 seconds, then expire the msg</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">				Meteor.setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
					loginButtonsSession.resetMessages();
				}, <span class="hljs-number">3000</span>);
			}
		});
	};

	<span class="hljs-keyword">var</span> matchPasswordAgainIfPresent = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31"></a>
</div>
<p>notably not trimmed. a password could (?) start or end with a space</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">		<span class="hljs-keyword">var</span> passwordAgain = elementValueById(<span class="hljs-string">'login-password-again'</span>);
		<span class="hljs-keyword">if</span> (passwordAgain !== <span class="hljs-literal">null</span>) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32"></a>
</div>
<p>notably not trimmed. a password could (?) start or end with a space</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">			<span class="hljs-keyword">var</span> password = elementValueById(<span class="hljs-string">'login-password'</span>);
			<span class="hljs-keyword">if</span> (password !== passwordAgain) {
				loginButtonsSession.errorMessage(<span class="hljs-string">"Passwords don't match"</span>);
				<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
			}
		}
		<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
	};
})();

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
